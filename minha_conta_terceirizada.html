<!-- minha_conta_terceirizada.html -->
<div class="card" style="max-width: 700px; margin: 0 auto; background: rgba(255,255,255,0.08); padding: 30px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); backdrop-filter: blur(10px); color: white;">

  <h2 style="margin-bottom: 20px; text-align: center;">
    <span style="margin-right: 6px;">üë§</span>Minha Conta
  </h2>

  <form id="formMinhaConta" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

    <div>
      <label>Nome da Empresa</label>
      <input type="text" name="nome" required style="width: 100%;" />
    </div>

    <div>
      <label>Propriet√°rio</label>
      <input type="text" name="proprietario" required style="width: 100%;" />
    </div>

    <div>
      <label>CNPJ</label>
      <input type="text" name="cnpj" disabled style="width: 100%; background-color: rgba(255,255,255,0.1); color: #ccc;" />
    </div>

    <div>
      <label>WhatsApp</label>
      <input type="tel" name="whatsapp" style="width: 100%;" />
    </div>

    <div>
      <label>Cidade</label>
      <input type="text" name="cidade" style="width: 100%;" />
    </div>

    <div>
      <label>Estado</label>
      <input type="text" name="estado" maxlength="2" style="width: 100%;" />
    </div>

    <div style="grid-column: span 2;">
      <label>Sobre a Empresa</label>
      <textarea name="sobre" style="width: 100%; min-height: 80px;"></textarea>
    </div>

    <div style="grid-column: span 2;">
      <label>Logomarca</label>
      <input type="file" name="logomarca" accept="image/*" style="width: 100%;" />
      <div id="logo-preview" style="margin-top: 12px;"></div>
    </div>

    <div style="grid-column: span 2; text-align: center; margin-top: 10px;">
      <button type="submit" style="padding: 10px 24px; font-weight: bold;">üíæ Salvar Altera√ß√µes</button>
    </div>
  </form>

  <div style="grid-column: span 2; margin-top: 20px; display: flex; justify-content: center; gap: 16px;">
    <button onclick="abrirTrocarSenha()" style="background: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">üîí Trocar Senha</button>
    <button onclick="confirmarExcluirConta()" style="background: #e53935; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">‚ùå Excluir Conta</button>
  </div>
</div>
<script>
async function carregarMinhaConta() {
  const id = localStorage.getItem("terceirizada_id");
  const res = await fetch(`${SUPABASE_URL}/rest/v1/terceirizadas?id=eq.${id}`, {
    headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
  });
  const dados = (await res.json())[0];
  if (!dados) return;

  const form = document.getElementById("formMinhaConta");
  form.nome.value = dados.nome || "";
  form.proprietario.value = dados.proprietario || "";
  form.cnpj.value = dados.cnpj || "";
  form.whatsapp.value = dados.contato || "";
  form.cidade.value = dados.cidade || "";
  form.estado.value = dados.estado || "";
  form.sobre.value = dados.sobre || "";

  if (dados.logomarca_url) {
  document.getElementById("logo-preview").innerHTML = `
    <p style="margin-top: 8px;">Logomarca atual:</p>
    <img src="${dados.logomarca_url}" alt="Logomarca atual" style="max-width: 160px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.4);">
  `;
}
}
document.getElementById("formMinhaConta").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const id = localStorage.getItem("terceirizada_id");

  const payload = {
    nome: form.nome.value,
    proprietario: form.proprietario.value,
    contato: form.whatsapp.value.replace(/\D/g, ""),
    cidade: form.cidade.value,
    estado: form.estado.value.toUpperCase(),
    sobre: form.sobre.value
  };

  // logomarca opcional
  const file = form.logomarca.files[0];
  if (file) {
    const nomeArquivo = `logo_${Date.now()}_${file.name}`;
    await fetch(`${SUPABASE_URL}/storage/v1/object/logos-terceirizadas/${nomeArquivo}`, {
      method: "POST",
      headers: {
        apikey: API_KEY,
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": file.type,
        "x-upsert": "true"
      },
      body: file
    });
    payload.logomarca_url = `${SUPABASE_URL}/storage/v1/object/public/logos-terceirizadas/${nomeArquivo}`;
  }

  await fetch(`${SUPABASE_URL}/rest/v1/terceirizadas?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      apikey: API_KEY,
      Authorization: `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  alert("‚úÖ Dados atualizados com sucesso!");
});

// Placeholder para a√ß√µes futuras
function abrirTrocarSenha() {
  alert("üîí Aqui voc√™ poder√° trocar sua senha.");
}
function confirmarExcluirConta() {
  const ok = confirm("Tem certeza que deseja excluir sua conta?");
  if (!ok) return;
  // Aqui entraria a l√≥gica real de exclus√£o
  alert("üö´ Conta exclu√≠da (exemplo)");
}

carregarMinhaConta();
</script>
