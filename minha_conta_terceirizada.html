<!-- minha_conta_terceirizada.html -->
<div class="card" style="max-width: 600px; margin: 0 auto;">
  <h2>üë§ Minha Conta</h2>
  <form id="formMinhaConta">

    <label>Nome da Empresa</label>
    <input type="text" name="nome" required />

    <label>Propriet√°rio</label>
    <input type="text" name="proprietario" required />

    <label>CNPJ</label>
    <input type="text" name="cnpj" disabled />

    <label>WhatsApp</label>
    <input type="tel" name="whatsapp" />

    <label>Cidade</label>
    <input type="text" name="cidade" />

    <label>Estado</label>
    <input type="text" name="estado" maxlength="2" />

    <label>Sobre a Empresa</label>
    <textarea name="sobre"></textarea>

    <label>Logomarca</label>
    <input type="file" name="logomarca" accept="image/*" />

    <button type="submit">üíæ Salvar Altera√ß√µes</button>
  </form>

  <div style="margin-top: 20px;">
    <button onclick="abrirTrocarSenha()">üîê Trocar Senha</button>
    <button onclick="confirmarExcluirConta()" style="background: #e53935;">‚ùå Excluir Conta</button>
  </div>
</div>

<script>
async function carregarMinhaConta() {
  const id = localStorage.getItem("terceirizada_id");
  const res = await fetch(`${SUPABASE_URL}/rest/v1/terceirizadas?id=eq.${id}`, {
    headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
  });
  const dados = (await res.json())[0];
  if (!dados) return;

  const form = document.getElementById("formMinhaConta");
  form.nome.value = dados.nome || "";
  form.proprietario.value = dados.proprietario || "";
  form.cnpj.value = dados.cnpj || "";
  form.whatsapp.value = dados.contato || "";
  form.cidade.value = dados.cidade || "";
  form.estado.value = dados.estado || "";
  form.sobre.value = dados.sobre || "";
}

document.getElementById("formMinhaConta").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const id = localStorage.getItem("terceirizada_id");

  const payload = {
    nome: form.nome.value,
    proprietario: form.proprietario.value,
    contato: form.whatsapp.value.replace(/\D/g, ""),
    cidade: form.cidade.value,
    estado: form.estado.value.toUpperCase(),
    sobre: form.sobre.value
  };

  // logomarca opcional
  const file = form.logomarca.files[0];
  if (file) {
    const nomeArquivo = `logo_${Date.now()}_${file.name}`;
    await fetch(`${SUPABASE_URL}/storage/v1/object/logos-terceirizadas/${nomeArquivo}`, {
      method: "POST",
      headers: {
        apikey: API_KEY,
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": file.type,
        "x-upsert": "true"
      },
      body: file
    });
    payload.logomarca_url = `${SUPABASE_URL}/storage/v1/object/public/logos-terceirizadas/${nomeArquivo}`;
  }

  await fetch(`${SUPABASE_URL}/rest/v1/terceirizadas?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      apikey: API_KEY,
      Authorization: `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  alert("‚úÖ Dados atualizados com sucesso!");
});

// Placeholder para a√ß√µes futuras
function abrirTrocarSenha() {
  alert("üîí Aqui voc√™ poder√° trocar sua senha.");
}
function confirmarExcluirConta() {
  const ok = confirm("Tem certeza que deseja excluir sua conta?");
  if (!ok) return;
  // Aqui entraria a l√≥gica real de exclus√£o
  alert("üö´ Conta exclu√≠da (exemplo)");
}

carregarMinhaConta();
</script>
