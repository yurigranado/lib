<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Backup Din√¢mico Supabase</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
      text-align: center;
      background: #f8f9fa;
    }
    button {
      padding: 16px 32px;
      font-size: 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>üì¶ Backup Autom√°tico (Todas as Tabelas)</h1>
  <button onclick="exportar()">Exportar Banco</button>
  <div id="status">Aguardando...</div>

  <script>
    const SUPABASE_URL = "https://lamjkztvgxuivnsrpvnr.supabase.co";
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhbWprenR2Z3h1aXZuc3Jwdm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MDI4MjcsImV4cCI6MjA2OTA3ODgyN30.2g1OX3rrUtA_KWrUqjI0ZFV3a8IhF-ydESnU5YBCY24";
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxToqnLsodbyjgOyL9Po0CaxrY2Fs7lwS30-AFXWez6OeilevBcr5LFPHyC487XI96y/exec";

    const HEADERS = {
      apikey: API_KEY,
      Authorization: `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    };

    async function buscarListaDeTabelas() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/listar_tabelas_publicas`, {
        method: "POST",
        headers: HEADERS
      });
      const json = await res.json();
      return json.map(t => t.nome);
    }

    async function buscarDadosDaTabela(tabela) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${tabela}?select=*`, {
        headers: HEADERS
      });
      return await res.json();
    }

    async function exportar() {
      document.getElementById("status").textContent = "üîç Buscando tabelas...";
      const tabelas = await buscarListaDeTabelas();
      const resultado = {};

      document.getElementById("status").textContent = `üì• Exportando ${tabelas.length} tabelas...`;

      for (const tabela of tabelas) {
        try {
          const dados = await buscarDadosDaTabela(tabela);
          resultado[tabela] = dados;
        } catch (erro) {
          resultado[tabela] = { erro: erro.message };
        }
      }

      const blob = new Blob([JSON.stringify(resultado, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_supabase_completo.json";
      a.click();

      document.getElementById("status").textContent = "‚úÖ Backup gerado com sucesso!";
    }
  </script>
</body>
</html>
