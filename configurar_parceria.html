<div class="card">
  <h2>ðŸ“„ Configurar Parceria com <span id="empresaNome"></span></h2>

  <form id="configForm">
    <label>Quais turnos vocÃª quer oferecer?</label>
    <div class="checkbox-list" id="turnoBox">
      <label><input type="checkbox" name="turnos" value="AlmoÃ§o" onchange="atualizarQtdMotoqueiros()"> AlmoÃ§o</label>
      <label><input type="checkbox" name="turnos" value="Jantar" onchange="atualizarQtdMotoqueiros()"> Jantar</label>
    </div>

    <div id="qtdMotoqueirosBox"></div>

    <label>VocÃª fornece alimentaÃ§Ã£o para o entregador?</label>
    <select name="alimentacao">
      <option value="Sim">Sim</option>
      <option value="NÃ£o">NÃ£o</option>
    </select>

    <label>Dia ideal para pagamento da frequÃªncia</label>
    <select name="dia_pagamento" onchange="toggleOutroPagamento(this.value)">
      <option>Segunda</option>
      <option>TerÃ§a</option>
      <option>Quarta</option>
      <option>Quinta</option>
      <option>Sexta</option>
      <option>Outro</option>
    </select>

    <div id="outrosPagamentoBox" style="display:none;">
      <label>Especifique como prefere pagar</label>
      <input type="text" name="pagamento_outros" />
    </div>

    <button type="submit">Enviar ConfiguraÃ§Ã£o</button>
  </form>
</div>

<script>
  function atualizarQtdMotoqueiros() {
    const selecionados = [...document.querySelectorAll('input[name="turnos"]:checked')];
    const qtdBox = document.getElementById("qtdMotoqueirosBox");
    qtdBox.innerHTML = "";
    selecionados.forEach(t => {
      qtdBox.innerHTML += `
        <label>Quantos motoqueiros para ${t.value}?</label>
        <input type="number" name="qtd_${t.value}" min="1" />
      `;
    });
  }

  function toggleOutroPagamento(valor) {
    const outroBox = document.getElementById("outrosPagamentoBox");
    outroBox.style.display = valor === "Outro" ? "block" : "none";
  }

  document.getElementById("configForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const empresaId = form.dataset.empresaId;
    const turnos = [...form.querySelectorAll('input[name="turnos"]:checked')].map(el => el.value);
    const qtdePorTurno = {};
    turnos.forEach(t => {
      const campo = form.querySelector(`input[name="qtd_${t}"]`);
      qtdePorTurno[t] = campo ? Number(campo.value) : 0;
    });

    const payload = {
      empresa_id: localStorage.getItem("empresa_id"),
      terceirizada_id: empresaId,
      status: "pendente",
      data_solicitacao: new Date().toISOString(),
      config_json: {
        turnos,
        qtdePorTurno,
        fornece_alimentacao: form.alimentacao.value,
        dia_pagamento: form.dia_pagamento.value,
        pagamento_outros: form.pagamento_outros?.value || ""
      }
    };

    await fetch(`${SUPABASE_URL}/rest/v1/contratos_empresas_terceirizadas`, {
      method: "POST",
      headers: {
        apikey: API_KEY,
        Authorization: `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    alert("Parceria solicitada com sucesso!");
    form.reset();
    document.getElementById("formularioConfig").innerHTML = "";
  });
</script>
